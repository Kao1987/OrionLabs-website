name: Deploy OrionLabs Website

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Security and Environment Check
        run: |
          echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æª¢æŸ¥..."
          yarn security:check
          
      - name: Type Check
        run: yarn type-check
        
      - name: Run Tests
        run: yarn test:run
        continue-on-error: true
        
      - name: Build project
        run: yarn build

      - name: Prepare deployment directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "ğŸš€ æº–å‚™éƒ¨ç½²ç’°å¢ƒ..."
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„èˆŠè‡¨æ™‚ç›®éŒ„
            rm -rf ~/dist
            echo "âœ… æº–å‚™å°±ç·’"

      - name: Upload build files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "dist"
          target: "~/"
          strip_components: 0
          overwrite: true
          rm: true

      - name: Move files to production and set permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "ğŸ“¦ é©—è­‰ä¸Šå‚³çš„æ–‡ä»¶..."
            # æª¢æŸ¥ä¸Šå‚³æ˜¯å¦æˆåŠŸ
            if [ ! -d ~/dist ]; then
              echo "âŒ éŒ¯èª¤ï¼šdist ç›®éŒ„ä¸å­˜åœ¨ï¼Œä¸Šå‚³å¤±æ•—ï¼"
              exit 1
            fi

            FILE_COUNT=$(find ~/dist -type f | wc -l)
            echo "ğŸ“Š ä¸Šå‚³äº† $FILE_COUNT å€‹æ–‡ä»¶"

            if [ "$FILE_COUNT" -lt 10 ]; then
              echo "âŒ éŒ¯èª¤ï¼šæ–‡ä»¶æ•¸é‡ç•°å¸¸ï¼ˆ$FILE_COUNTï¼‰ï¼Œæ‡‰è©²æœ‰ 40+ å€‹æ–‡ä»¶"
              exit 1
            fi

            echo "ğŸ“¦ ç§»å‹•æª”æ¡ˆåˆ°ç”Ÿç”¢ç›®éŒ„..."
            # å‰µå»ºå‚™ä»½ï¼ˆå¦‚æœç”Ÿç”¢ç›®éŒ„å­˜åœ¨ï¼‰
            if [ -d /var/www/orionlabs.pro/personal-brand-website/dist ]; then
              echo "ğŸ’¾ å‰µå»ºå‚™ä»½..."
              sudo rm -rf /var/www/orionlabs.pro/personal-brand-website/dist.backup
              sudo cp -r /var/www/orionlabs.pro/personal-brand-website/dist /var/www/orionlabs.pro/personal-brand-website/dist.backup
              echo "âœ… å‚™ä»½å®Œæˆ"
            fi

            # æ¸…ç©ºèˆŠæ–‡ä»¶
            sudo rm -rf /var/www/orionlabs.pro/personal-brand-website/dist/*

            # è¤‡è£½æ–°æ–‡ä»¶
            sudo cp -r ~/dist/* /var/www/orionlabs.pro/personal-brand-website/dist/

            # æ¸…ç†è‡¨æ™‚æ–‡ä»¶
            rm -rf ~/dist

            # è¨­ç½®æ­£ç¢ºæ¬Šé™
            sudo chown -R www-data:www-data /var/www/orionlabs.pro/personal-brand-website/dist
            sudo chmod -R 755 /var/www/orionlabs.pro/personal-brand-website/dist

            # é©—è­‰éƒ¨ç½²
            DEPLOYED_COUNT=$(find /var/www/orionlabs.pro/personal-brand-website/dist -type f | wc -l)
            echo "ğŸ“Š ç”Ÿç”¢ç’°å¢ƒæ–‡ä»¶æ•¸é‡ï¼š$DEPLOYED_COUNT"

            # æª¢æŸ¥é—œéµæ–‡ä»¶
            if [ ! -f /var/www/orionlabs.pro/personal-brand-website/dist/index.html ]; then
              echo "âŒ éŒ¯èª¤ï¼šindex.html ä¸å­˜åœ¨ï¼"
              exit 1
            fi

            # é¡¯ç¤ºéƒ¨ç½²çš„ JS bundle ç‰ˆæœ¬
            JS_FILE=$(ls /var/www/orionlabs.pro/personal-brand-website/dist/index-*.js 2>/dev/null | head -1 | xargs basename)
            echo "ğŸ“¦ JS Bundle: $JS_FILE"

            # é‡è¼‰ nginx
            sudo systemctl reload nginx
            echo "âœ… éƒ¨ç½²å®Œæˆä¸¦å·²é©—è­‰ï¼"
